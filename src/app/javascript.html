<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
  /**
   * On document load, assign required handlers to each element,
   * and attempt to load any saved settings.
   */
  $(function() {
    $(document).ready(function(){
      google.script.run.withSuccessHandler(function(data) {
        // Creating variables to the event listeners.
        var cityName;
        var selectedState;
        var ibgeData = data;

        introWallLoad(data);

        // Events listeners
        $('#dropdown-list').on('change', function() {
          // Get the selected value
          selectedState = $(this).val();
          console.log("selected uf: " + selectedState)

          // Get introwall to proceed with its animation
          const introWall = document.querySelector(".intro-wall");
          
          // Filter ibge data to get only the cities in the state that the user selected.
          const stateObj = ibgeData.filter(obj => obj["UF-sigla"] === selectedState);

          // Call handlers and loaders
          getCityObject(stateObj)

          // Trigger the animation to move the wall up and disappear
          introWall.style.animationPlayState = "running";
          
          // Hide the intro wall and reveal the other elements
          setTimeout(() => {
              introWall.style.display = "none";
          }, 3000); // Adjust the duration to match your animation
        });

        $('#guessInput').keypress(function(e) {
          if(e.which == 13) { // Detect Enter key
            $('#guessButton').click(); // Trigger click on the "Adivinhar" button
            return false; // Prevent the form from submitting
          }
        });
      
        $('#guessButton').on("click", function() {
          console.log(cityName)
          const guess = lowerCaseStrAndRemoveAccents($('#guessInput').val());

          if (guess === cityName) {
            $('html').fadeOut(2200); // TEMPORARY - 2.2 secs of fadeout
            getCityObject(selectedState) // Execute load workflow to get another city. (Basically a "play again" method)
            $('html').fadeIn(1200); // TEMPORARY - 1..2 secs of fadein to
            //$("#successIcon").show();
            //$('#guessResult').append('Correto! Você acertou o nome da cidade.');
            //$('#guessResult').addClass('success')
          }
        })
      }).getIBGECitiesData();
    });

    // Start point of our JS; Intro Wall function
    function introWallLoad(data) {
      // Pull introwall elements
      const dropdown = document.getElementById("dropdown-list");

      // Extract unique UF-siglas using a Set
      const ufsSet = new Set();

      data.forEach(cityData => {
        ufsSet.add(cityData["UF-sigla"]);
      });

      // Convert the Set to an array and sort it
      const ufs = Array.from(ufsSet).sort();

      // Populate the dropdown list with the ufs
      ufs.forEach(uf => {
        const option = document.createElement("option");
        option.value = uf;
        option.text = uf;
        dropdown.appendChild(option);
      });
    }

    // Helpers
    function lowerCaseStrAndRemoveAccents(str) {
      return str.toLowerCase().normalize('NFD').replace(/\p{Mn}/gu, "")
    }

    /**
     * Get IBGE data object from server.
     */
    function getCityObject(stateObj) {
      google.script.run
        .withSuccessHandler(function(contents) {
          // Responding to incoming contents, updating page.
          loadElementsData(contents)
        })
        .withFailureHandler(function(err){
          console.error("Error: ", e);
        })
        .getIBGERandomCityObject(stateObj);
    }
    
    /**
     * Main function to load page elemnts based on city object.
     */
    function loadElementsData(data) {
      // Load city name var
      cityName = getCityName(data)

      // Updating hints
      updateStateHint(data);
      updateMicroRegionHint(data)

      // Updating image
      updateImageUrl(data)
    }

    function updateStateHint(data) {
      const hint = data['UF-nome']; // State
      const hintText = "Dica: Esta cidade está no estado de " + hint;
      $('#stateHint').html(''); // Clear element if has any text
      $('#stateHint').html(hintText);
    }

    function updateMicroRegionHint(data) {
      const hint = data['mesorregiao-nome']; // Micro Region
      const hintText = "Dica: Esta cidade está na mesorregião " + hint + " do estado.";
      $('#microRegionHint').html(''); // Clear element if has any text
      $('#microRegionHint').html(hintText);
    }

    function updateImageUrl(data) {
      const url = `${IBGEApiBaseUrl}${data['municipio-id']}`;
      $('#cityImage').attr('src', url);
    }

    function getCityName(data) {
      const cityName = lowerCaseStrAndRemoveAccents(data['municipio-nome']);
      return cityName;
    }
  });
</script>